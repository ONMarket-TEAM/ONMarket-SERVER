name: Deploy to EC2

on:
  push:
    branches: [ develop, main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
     
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Build with Gradle
      run: ./gradlew build -x test
      
    - name: Upload JAR to EC2
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "build/libs/onmarket-0.0.1-SNAPSHOT.jar"
        target: "/home/ec2-user/onmarket-new.jar"
        
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          # 현재 실행 중인 Java 프로세스의 포트 확인
          CURRENT_PORT=8081
          NEW_PORT=8080
          if pgrep -f "server.port=8080" > /dev/null; then
            CURRENT_PORT=8080
            NEW_PORT=8081
          fi
          
          echo "Current port: $CURRENT_PORT, New port: $NEW_PORT"
          
          # 새 버전을 다른 포트에서 실행
          nohup java -Dserver.port=$NEW_PORT -jar onmarket-new.jar > app-$NEW_PORT.log 2>&1 &
          NEW_PID=$!
          
          # 새 앱이 시작될 때까지 대기
          echo "Waiting for new application to start on port $NEW_PORT..."
          for i in {1..30}; do
            if curl -f http://localhost:$NEW_PORT/login > /dev/null 2>&1; then
              echo "New application is running on port $NEW_PORT"
              break
            fi
            echo "Attempt $i: Application not ready yet..."
            sleep 2
          done
          
          # 헬스체크 성공 시 Nginx 설정 변경
          if curl -f http://localhost:$NEW_PORT/login > /dev/null 2>&1; then
            echo "Health check passed. Switching Nginx to port $NEW_PORT"
            
            # Nginx 설정 파일에서 포트 변경
            sudo sed -i "s/proxy_pass http:\/\/localhost:[0-9]*/proxy_pass http:\/\/localhost:$NEW_PORT/" /etc/nginx/conf.d/onmarket.conf
            
            # Nginx 설정 테스트 및 리로드
            sudo nginx -t && sudo systemctl reload nginx
            
            # 기존 프로세스 종료
            OLD_PID=$(pgrep -f "server.port=$CURRENT_PORT")
            if [ ! -z "$OLD_PID" ]; then
              echo "Killing old process: $OLD_PID"
              kill $OLD_PID
            fi
            
            echo "Deployment completed successfully!"
            
          else
            echo "Health check failed. Rolling back..."
            kill $NEW_PID
            exit 1
          fi
